## 单表查询

### 简单查询

使用了BOOKSHOP数据

1. 查询所有图书的名字、作者及当前销售价格，并消去重复。

`SELECT DISTINCT NAME, AUTHOR, NOWPRICE FROM PRODUCTION .PRODUCT;`

2. 查询PERSON表的内容

`SELECT * FROM PERSON.PERSON;` 

或者

`SELECT PERSONID, NAME, SEX, EMAIL, PHONE FROM PERSON.PERSON;`

<img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719095248090.png" alt="image-20210719095248090" style="zoom: 50%;" />

3. 查询 tt 表中有的，kk 表中没有的数据

   `SELECT * FROM TT MINUS SELECT * FROM KK;` 

   或者

   `SELECT * FROM TT EXCEPT SELECT * FROM KK;`

   <img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719100147368.png" alt="image-20210719100147368" style="zoom:50%;" />

4. 查询 tt 表和 kk 表都有的数据。

   `SELECT * FROM TT INTERSECT SELECT * FROM KK;` 

   <img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719100237762.png" alt="image-20210719100237762" style="zoom:50%;" />



### 带条件查询

#### 1. 使用比较谓词的查询

给出当前销售价格在 10～20 元之间的所有图书的名字、作者、出版社和当前价格。

`SELECT NAME, AUTHOR, PUBLISHER, NOWPRICE FROM PRODUCTION.PRODUCT WHERE NOWPRICE>=10 AND NOWPRICE<=20;`

<img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719100522600.png" alt="image-20210719100522600" style="zoom:50%;" />

#### 2. 使用 BETWEEN 谓词的查询

给出当前销售价格在 10～20 元之间的所有图书的名字、作者、出版社和当前价格。

`SELECT NAME, AUTHOR, PUBLISHER, NOWPRICE FROM PRODUCTION.PRODUCT WHERE NOWPRICE BETWEEN 10 AND 20;`

<img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719100912029.png" alt="image-20210719100912029" style="zoom:50%;" />

#### 3. 使用 IN 谓词的查询

查询出版社为中华书局或人民文学出版社出版的图书名称与作者信息。

`SELECT NAME, AUTHOR FROM PRODUCTION.PRODUCT WHERE PUBLISHER IN ('中华书局', '人民文学出版社');`

<img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719101002479.png" alt="image-20210719101002479" style="zoom:50%;" />

#### 4. 使用 LIKE 谓词的查询

查询第一通讯地址中第四个字开始为“关山”且以 202 结尾的地址。

`SELECT ADDRESSID, ADDRESS1, CITY, POSTALCODE FROM PERSON.ADDRESS WHERE ADDRESS1 LIKE '___关山%202';`

<img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719101117087.png" alt="image-20210719101117087" style="zoom:80%;" />

查询第一通讯地址以 C1_501 结尾的地址

`SELECT ADDRESSID, ADDRESS1, CITY, POSTALCODE FROM PERSON.ADDRESS WHERE ADDRESS1 LIKE '%C1*_501' ESCAPE '*';`

![image-20210719101228915](DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719101228915.png)

#### 5. 使用.ROW 进行 LIKE 谓词的查询

查询评论中哪些与曹雪芹有关

`SELECT * FROM PRODUCTION. PRODUCT_REVIEW WHERE NAME LIKE '%曹雪芹%' OR EMAIL LIKE '%曹雪芹%' OR COMMENTS LIKE '%曹雪芹%';`

#### 6. 使用 NULL 谓词的查询

查询哪些人员的 EMAIL 地址为 NULL

`SELECT NAME, SEX, PHONE FROM PERSON.PERSON WHERE EMAIL IS NULL;`

<img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719102030853.png" alt="image-20210719102030853" style="zoom:50%;" />

#### 7. 组合逻辑

查询当前销售价格低于 15 元且折扣低于 7 或出版社为人民文学出版社的图书名称 和作者

<img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719102222608.png" alt="image-20210719102222608" style="zoom:50%;" />

### 集函数

1. 求最大值集函数 MAX 和求最小值集函数 MIN

   - 查询折扣小于 7 的图书中现价最低的价格

   `SELECT MIN(NOWPRICE) FROM PRODUCTION.PRODUCT WHERE DISCOUNT < 7;`

   <img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719103354053.png" alt="image-20210719103354053" style="zoom:50%;" />

2. 求平均值集函数 AVG 和总和集函数 SUM

   - 求折扣小于 7 的图书的平均现价

   `SELECT AVG(NOWPRICE) FROM PRODUCTION.PRODUCT WHERE DISCOUNT < 7;`

   <img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719103637483.png" alt="image-20210719103637483" style="zoom:50%;" />

   - 求折扣大于 8 的图书的总价格

   <img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719103726050.png" alt="image-20210719103726050" style="zoom:50%;" />

3. 求总个数集函数 COUNT

   - 查询已登记供应商的个数

   `SELECT COUNT(*) FROM PURCHASING.VENDOR;`

   <img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719103833588.png" alt="image-20210719103833588" style="zoom:50%;" />

   - 查询目前销售的图书的出版商的个数

     `SELECT COUNT(DISTINCT PUBLISHER) FROM PRODUCTION.PRODUCT;`

     <img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719104003700.png" alt="image-20210719104003700" style="zoom:50%;" />

4. 求方差集函数 VARIANCE、标准差函数 STDDEV 和样本标准差函数 STDDEV_SAMP

   - 求图书的现价方差

      `SELECT VARIANCE(NOWPRICE) FROM PRODUCTION.PRODUCT;` 

   - 求图书的现价标准差 

     `SELECT STDDEV(NOWPRICE) FROM PRODUCTION.PRODUCT;` 

   - 求图书的现价样本标准差

     `SELECT STDDEV_SAMP(NOWPRICE) FROM PRODUCTION.PRODUCT;`

5. 求总体协方差集函数 COVAR_POP、样本协方差函数 COVAR_SAMP 和相关系数 CORR

   - 求产品原始价格 ORIGINALPRICE 和当头销售价格 NOWPRICE 的总体协方差。 

     `SELECT COVAR_POP(ORIGINALPRICE, NOWPRICE) FROM PRODUCTION.PRODUCT;` 

   - 求产品原始价格 ORIGINALPRICE 和当头销售价格 NOWPRICE 的样本协方差。 

     `SELECT COVAR_SAMP(ORIGINALPRICE, NOWPRICE) FROM PRODUCTION.PRODUCT;` 

   - 求产品原始价格 ORIGINALPRICE 和当头销售价格 NOWPRICE 的相关系数。 

     `SELECT CORR(ORIGINALPRICE, NOWPRICE) FROM PRODUCTION.PRODUCT;`

6. 首行函数 FIRST_VALUE

   - 返回查询项的首行记录

     `SELECT FIRST_VALUE(NAME) FROM PRODUCTION.PRODUCT;`

     <img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719104537496.png" alt="image-20210719104537496" style="zoom:50%;" />

7. 求区间范围内的最大值函数 AREA_MAX

   - 求图书的现价在 20~30 之间的最大值

     `SELECT area_max(NOWPRICE,20,30) FROM PRODUCTION.PRODUCT; `

     <img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719104632838.png" alt="image-20210719104632838" style="zoom:50%;" />

8. 求 FIRST/LAST 集函数

   - 求每个用户最早定的商品中花费最多和最少的金额 

     ```sql
     select CUSTOMERID, max(TOTAL) keep (dense_rank first order by ORDERDATE) max_val, min(TOTAL) keep (dense_rank first order by ORDERDATE) min_val from SALES.SALESORDER_HEADER group by CUSTOMERID;
     ```

     <img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719104956571.png" alt="image-20210719104956571" style="zoom:50%;" />

9. 求 LISTAGG/LISTAGG2 集函数

   - 求出版的所有图书

     ```sql
     SELECT LISTAGG(NAME, ', ') WITHIN GROUP (ORDER BY NAME) LISTAGG FROM
     PRODUCTION.PRODUCT;
     
     或
     
     SELECT LISTAGG2(NAME, ', ') WITHIN GROUP (ORDER BY NAME) LISTAGG FROM
     PRODUCTION.PRODUCT;
     
     ```

10. 求 MEDIAN 集函数

    - 求按照 type 分组之后，各组内 nowprice 的中位数

      `SELECT MEDIAN(nowprice)FROM PRODUCTION.PRODUCT group by(type);`

      <img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719105156828.png" alt="image-20210719105156828" style="zoom:50%;" />

11. 求 WM_CONCAT 集函数

    - 求每个出版社出版的所有图书

      `SELECT PUBLISHER, WM_CONCAT(NAME) FROM PRODUCTION.PRODUCT GROUP BY PUBLISHER;`

      <img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719105258937.png" alt="image-20210719105258937" style="zoom:50%;" />



### 分析函数

1. 最大值 MAX 和最小值 MIN

   - 查询折扣大于 7 的图书作者以及最大折扣

     ```sql
     SELECT AUTHOR, MAX(DISCOUNT) OVER (PARTITION BY AUTHOR) AS MAX FROM PRODUCTION.PRODUCT WHERE DISCOUNT > 7;
     ```

     <img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719110218092.png" alt="image-20210719110218092" style="zoom:50%;" />

2. 平均值 AVG 和总和 SUM

   - 求折扣小于 7 的图书作者和平均价格

     ```sql
     SELECT AUTHOR, AVG(NOWPRICE) OVER (PARTITION BY AUTHOR) as AVG FROM PRODUCTION.PRODUCT WHERE DISCOUNT < 7;
     ```

     <img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719111026059.png" alt="image-20210719111026059" style="zoom:50%;" />

3. 样本个数 COUNT

   - 求折扣大于 8 的图书作者和书的总价格 

     ```sql
     SELECT AUTHOR, SUM(NOWPRICE) OVER (PARTITION BY AUTHOR) as SUM FROM PRODUCTION.PRODUCT WHERE DISCOUNT >8;
     ```

     <img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719111215380.png" alt="image-20210719111215380" style="zoom:50%;" />

4. 分析函数总体协方差 COVAR_POP

   - 求产品原始价格 ORIGINALPRICE 和当前销售价格 NOWPRICE 的总体协方差

     ```sql
     SELECT PUBLISHER, COVAR_POP(ORIGINALPRICE, NOWPRICE) OVER(PARTITION BY PUBLISHER) AS COVAR_POP FROM PRODUCTION.PRODUCT; 
     ```

     <img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719111605083.png" alt="image-20210719111605083" style="zoom:50%;" />

5. 分析函数样本协方差 COVAR_SAMP

   - 求产品原始价格 ORIGINALPRICE 和当前销售价格 NOWPRICE 的样本协方差

     ```sql
     SELECT PUBLISHER, COVAR_SAMP(ORIGINALPRICE, NOWPRICE) OVER(PARTITION BY PUBLISHER) AS COVAR_SAMP FROM PRODUCTION.PRODUCT; 
     ```

     <img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719112343522.png" alt="image-20210719112343522" style="zoom:50%;" />

6. 相关系数 CORR

   -  求产品原始价格 ORIGINALPRICE 和当前销售价格 NOWPRICE 的相关系数

     ```sql
     SELECT PUBLISHER, CORR(ORIGINALPRICE, NOWPRICE) OVER(PARTITION BY PUBLISHER) AS CORR FROM PRODUCTION.PRODUCT; 
     ```

     <img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719112500332.png" alt="image-20210719112500332" style="zoom:50%;" />

7. 排名 RANK、DENSE_RANK 和 ROW_NUMBER

   - 求按销售额排名的销售代表对应的雇员号和排名。 

     ```sql
     SELECT EMPLOYEEID, RANK() OVER (ORDER BY SALESLASTYEAR) AS RANK FROM SALES.SALESPERSON;
     ```

     <img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719112735811.png" alt="image-20210719112735811" style="zoom:50%;" />

8. FIRST 和 LAST

   - 求每个用户最早定的商品中花费最多和最少的金额以及用户当前的花费金额

     ```sql
     SELECT CUSTOMERID, TOTAL, MAX(TOTAL) KEEP (DENSE_RANK FIRST ORDER BY ORDERDATE) OVER (PARTITION BY CUSTOMERID) MAX_VAL, MIN(TOTAL) KEEP (DENSE_RANK FIRST ORDER BY ORDERDATE) OVER (PARTITION BY CUSTOMERID) MIN_VAL FROM SALES.SALESORDER_HEADER;
     ```

     <img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719112925460.png" alt="image-20210719112925460" style="zoom:50%;" />

9. FIRST_VALUE 和 LAST_VALUE 分析函数

   - 求花费最多和最少金额的用户和花费金额

     ```sql
     SELECT NAME, TOTAL,
     FIRST_VALUE(NAME) OVER (ORDER BY TOTAL) FIRST_PERSON,LAST_VALUE(NAME) OVER (ORDER BY TOTAL) LAST_PERSON
     FROM SALES.SALESORDER_HEADER S,SALES.CUSTOMER C,PERSON.PERSON P
     WHERE S.CUSTOMERID = C.CUSTOMERID AND C.PERSONID = P.PERSONID;
     ```

     <img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719113535564.png" alt="image-20210719113535564" style="zoom:50%;" />

10. LAG 和 LEAD

    - 求当前订单的前一个和下一个订单的销售总额

      ```sql
      SELECT
      ORDERDATE,
      LAG(TOTAL, 1, 0) OVER (ORDER BY ORDERDATE) PRV_TOTAL,
      LEAD(TOTAL, 1, 0) OVER (ORDER BY ORDERDATE) NEXT_TOTAL
      FROM SALES.SALESORDER_HEADER;
      ```

      <img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719113653701.png" alt="image-20210719113653701" style="zoom:50%;" />

11. 窗口的使用

    - 按照作者分类，求到目前为止图书价格最贵的作者和价格

      ```sql
      SELECT AUTHOR,
      MAX(NOWPRICE) OVER(PARTITION BY AUTHOR ORDER BY NOWPRICE ROWS
      UNBOUNDED PRECEDING) AS MAX_PRICE
      FROM PRODUCTION.PRODUCT;
      ```

      <img src="DM%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5.assets/image-20210719113751109.png" alt="image-20210719113751109" style="zoom:50%;" />

12. 标准差 STDDEV

    - 求每个出版社图书现价的标准差

      ```sql
      SELECT PUBLISHER, STDDEV(NOWPRICE) OVER(PARTITION BY PUBLISHER) AS STDDEV FROM PRODUCTION.PRODUCT; 
      ```

      <img src="%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2.assets/image-20210719114112241.png" alt="image-20210719114112241" style="zoom:50%;" />

13. 样本标准差 STDDEV_SAMP

    - 求每个出版社图书现价的样本标准差

      ```sql
      SELECT PUBLISHER, STDDEV_SAMP(NOWPRICE) OVER(PARTITION BY PUBLISHER) AS STDDEV_SAMP FROM PRODUCTION.PRODUCT;
      ```

      <img src="%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2.assets/image-20210719114251165.png" alt="image-20210719114251165" style="zoom:50%;" />

14. 总体标准差 STDDEV_POP

    - 求每个出版社图书现价的总体标准差 

      ```sql
      SELECT PUBLISHER, STDDEV_POP (NOWPRICE) OVER(PARTITION BY PUBLISHER) AS STDDEV_POP FROM PRODUCTION.PRODUCT;
      ```

      <img src="%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2.assets/image-20210719131531143.png" alt="image-20210719131531143" style="zoom:80%;" />

15. 样本方差 VAR_SAMP

    - 求每个出版社图书现价的样本方差

      ```sql
      SELECT PUBLISHER, VAR_SAMP(NOWPRICE) OVER(PARTITION BY PUBLISHER) AS
      VAR_SAMP FROM PRODUCTION.PRODUCT; 
      ```

      <img src="%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2.assets/image-20210719131755405.png" alt="image-20210719131755405" style="zoom:50%;" />

16. 总体方差 VAR_POP

    - 求每个出版社图书现价的总体方差 

      ```sql
      SELECT PUBLISHER , VAR_POP(NOWPRICE) OVER(PARTITION BY PUBLISHER) AS VAR_POP FROM PRODUCTION.PRODUCT; 
      ```

      <img src="%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2.assets/image-20210719132102709.png" alt="image-20210719132102709" style="zoom:50%;" />

17. 方差 VARIANCE

    - 求每个出版社图书现价的方差

      ```sql
      SELECT PUBLISHER, VARIANCE (NOWPRICE) OVER(PARTITION BY PUBLISHER) AS VARIANCE FROM PRODUCTION.PRODUCT;
      ```

      <img src="%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2.assets/image-20210719132150239.png" alt="image-20210719132150239" style="zoom:50%;" />

18. 分组 NTILE

    - 根据图书的现价将图书分成三个组

      ```sql
      SELECT NAME, NTILE (3) OVER(ORDER BY NOWPRICE) AS NTILE FROM PRODUCTION.PRODUCT;
      ```

      <img src="%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2.assets/image-20210719132411195.png" alt="image-20210719132411195" style="zoom:50%;" />

19. 排列百分比 PERCENT_RANK

    - 求图书的现价排列百分比

      ```sql
      SELECT NAME, PERCENT_RANK() OVER(ORDER BY NOWPRICE) AS NTILE FROM
      PRODUCTION.PRODUCT; 
      ```

      <img src="%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2.assets/image-20210719132808921.png" alt="image-20210719132808921" style="zoom:50%;" />

20. 连续百分比对应的值 PERCENTILE_CONT

    - 求连续百分比占 0.5 对应的图书现价值

      ```sql
      SELECT NAME, PERCENTILE_CONT(0.5) WITHIN GROUP(ORDER BY NOWPRICE) OVER() AS PERCENTILE_CONT FROM PRODUCTION.PRODUCT; 
      ```

      <img src="%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2.assets/image-20210719133044748.png" alt="image-20210719133044748" style="zoom:50%;" />

21. 分布百分比对应的值 PERCENTILE_DISC

    - 求分布百分比占 0.5 对应的图书现价值

      ```sql
      SELECT NAME, PERCENTILE_DISC(0.5) WITHIN GROUP(ORDER BY NOWPRICE) OVER() AS PERCENTILE_DISC FROM PRODUCTION.PRODUCT;
      ```

      <img src="%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2.assets/image-20210719133145779.png" alt="image-20210719133145779" style="zoom:50%;" />

22. .累计百分比 CUME_DIST

    - 求图书现价的累计百分比

      ```sql
      SELECT NAME, CUME_DIST() OVER(ORDER BY NOWPRICE) AS CUME_DIST FROM PRODUCTION.PRODUCT;
      ```

      <img src="%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2.assets/image-20210719133327131.png" alt="image-20210719133327131" style="zoom:50%;" />

23. 某一样本值所占百分比 RATIO_TO_REPORT

    - 求出版社每种图书现价所占的百分比

      ```sql
      SELECT NAME, RATIO_TO_REPORT(NOWPRICE) OVER(PARTITION BY PUBLISHER) AS RATIO_TO_REPORT FROM PRODUCTION.PRODUCT; 
      ```

24. 组内指定行 NTH_VALUE

    - 求每个出版社第二贵的书的价格

      ```sql
      SELECT PUBLISHER, NTH_VALUE(NOWPRICE, 2) FROM FIRST RESPECT NULLS OVER(PARTITION BY PUBLISHER ORDER BY NOWPRICE DESC) AS NTH_VALUE FROM PRODUCTION.PRODUCT;
      ```

      <img src="%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2.assets/image-20210719133622450.png" alt="image-20210719133622450" style="zoom:50%;" />

    - 利用窗口子句求每个出版社第二贵的书的价格

      ```sql
      SELECT PUBLISHER, NTH_VALUE(NOWPRICE, 2) FROM FIRST RESPECT NULLS OVER(PARTITION BY PUBLISHER ORDER BY NOWPRICE DESC ROWS UNBOUNDED PRECEDING) AS NTH_VALUE FROM PRODUCTION.PRODUCT;
      ```

25. 字符串分析函数 WM_CONCAT

    - 求每个出版社出版的图书。先根据 PARTITION BY 项进行分组，然后将组内的参 数值通过‖,‖拼接起来

      ```sql
      SELECT PUBLISHER, WM_CONCAT(NAME) OVER (PARTITION BY PUBLISHER) AS WM_CONCAT FROM PRODUCTION.PRODUCT;
      ```

      <img src="%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2.assets/image-20210719133909302.png" alt="image-20210719133909302" style="zoom:50%;" />



### 情况表达式

1. 查询图书信息，如果当前销售价格大于 20 元，返回“昂贵”，如果当前销售价格小 于等于 20 元，大于等于 10 元，返回“普通”，如果当前销售价格小于 10 元，返回“便宜”。

   ```sql
   SELECT NAME,
    CASE
    	WHEN NOWPRICE > 20 THEN '昂贵'
    	WHEN NOWPRICE <= 20 AND NOWPRICE >= 10 THEN '普通'
    ELSE '便宜'
   END AS 选择
   FROM PRODUCTION.PRODUCT;
   ```

   <img src="%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2.assets/image-20210719134609947.png" alt="image-20210719134609947" style="zoom:50%;" />

2. 在 VERDOR 中如果 NAME 为中华书局或清华大学出版社，且 CREDIT 为 1 则返回“采 购”，否则返回“考虑”。

   ```sql
   SELECT NAME,
    CASE
   WHEN (NAME = '中华书局' OR NAME = '清华大学出版社') AND CREDIT = 1 THEN
   '采购'
   ELSE '考虑'
    END AS 选择
   FROM PURCHASING.VENDOR;
   ```

   <img src="%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2.assets/image-20210719134658352.png" alt="image-20210719134658352" style="zoom:50%;" />

3. 在上述表中将 NAME 为中华书局，CREDIT 为 1 的元组返回。

   ```sql
   SELECT NAME, CREDIT FROM PURCHASING.VENDOR
   WHERE NAME IN (SELECT CASE
    WHEN CREDIT = 1 THEN '中华书局'
    ELSE 'NOT EQUAL'
    END
    FROM PURCHASING.VENDOR);
   ```

   <img src="%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2.assets/image-20210719135028905.png" alt="image-20210719135028905" style="zoom:50%;" />

4. 在上述表中，若 CREDIT 大于 1 则修改该值为 1。

   ```sql
   UPDATE PURCHASING.VENDOR SET CREDIT = CASE
    WHEN CREDIT > 1 THEN 1
    ELSE CREDIT
   END;
   SELECT NAME, CREDIT FROM PURCHASING.VENDOR;
   ```

   <img src="%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2.assets/image-20210719135427856.png" alt="image-20210719135427856" style="zoom:50%;" />

